name: Dependabot auto merge
description: "Automatically merges Dependabot PRs, but requires manual approval for major version bumps or low compatibility"

inputs:
  github-token:
    description: GITHUB_TOKEN authentication
    required: true
  pr-url:
    description: Pull request html url
    required: true

runs:
  using: composite
  steps:
    - name: Fetch Dependabot metadata
      id: metadata
      uses: dependabot/fetch-metadata@v2
      with:
        github-token: ${{ inputs.github-token }}

    - name: Check if manual approval required
      shell: bash
      run: |
        UPDATE_TYPE="${{ steps.metadata.outputs.update-type }}"
        COMPAT_SCORE="${{ steps.metadata.outputs.compatibility-score }}"
        
        echo "Update type: ${UPDATE_TYPE:-unknown}"
        echo "Compatibility score: ${COMPAT_SCORE:-unknown}"
        
        # Require approval for major version bumps
        if [[ "$UPDATE_TYPE" == "version-update:semver-major" ]]; then
          echo "⚠️ Major version bump detected. Manual approval required."
          exit 1
        fi
        
        # Require approval for low compatibility (score < 0.5)
        # Compatibility score is a number between 0 and 1
        if [[ -n "$COMPAT_SCORE" ]]; then
          # Use awk for floating point comparison (available in all Linux environments)
          if awk "BEGIN {exit !($COMPAT_SCORE < 0.5)}"; then
            echo "⚠️ Low compatibility score ($COMPAT_SCORE). Manual approval required."
            exit 1
          fi
        fi
        
        echo "✅ Safe to auto-merge (update type: ${UPDATE_TYPE:-unknown}, compatibility: ${COMPAT_SCORE:-unknown})"

    - name: Enable auto-merge for Dependabot PRs
      shell: bash
      run: |
        gh pr review --approve "${{ inputs.pr-url }}"
        gh pr merge --auto --squash "${{ inputs.pr-url }}"
      env:
        PR_URL: ${{ inputs.pr-url }}
        GITHUB_TOKEN: ${{ inputs.github-token }}
