# Release Management

## Overview

- Primer follows semantic versioning using tags like `v0.0.1` and keeps `main` releasable at all times.
- Each published release serves three audiences:
  - **Contributor developers** work from source, using seed data and the contribution guide.
  - **User developers** download tagged source archives and configure their own environments without seed data.
  - **User non-developers** download prebuilt frontend/backend bundles packaged with the release.
- GitHub Releases act as authoritative “working version” markers. Release notes link to documentation, artifacts, GitHub Pages demo, and any migrations.

## Versioning & Branching

- Tag releases with the `vX.Y.Z` pattern. The current baseline is `v0.0.1`.
- Create release branches named `release/vX.Y.Z` from `main` when preparing a new release.
- Use pull requests to merge release branches back to `main` after validation; protect `main` with CI checks.

## Release Workflow

1. **Open a release issue** using the `Release planning` template (see `.github/ISSUE_TEMPLATE/release.md`). Capture scope, owners, and target date.
2. **Create a release branch** `release/vX.Y.Z` from `main`.

```bash
# 1. Make sure you're on main and it's up to date
git checkout main
git pull origin main

# 2. Create and switch to the new release branch
git checkout -b release/v0.0.1

# 3. Push the branch to GitHub
git push -u origin release/v0.0.1
```

3. **Stabilise the branch**:
   - Run unit/integration tests and lint checks.
   - Update documentation (`docs/releases.md`, per-audience guides) and bump versions (`template-version.json`, package manifests if required).
   - Verify GitHub Pages content will align with the release data snapshot.
4. **Create a release pull request** targeting `main`:
   - Reference the release issue.
   - Include the checklist below in the PR description.
   - Ensure CI passes on the branch.
5. **Finish release**:
   - Merge the PR once approvals and checks succeed.
   - Tag the merge commit locally or via CI and push (`git tag vX.Y.Z && git push origin vX.Y.Z`).
   - Draft the GitHub Release using the notes template; attach artifacts generated by the release workflow.
6. **Publish and communicate**:
   - Publish the release after verifying assets and notes.
   - Close the release issue, linking to the GitHub Release entry and any follow-up tasks.

## Release Checklist

Include this checklist in the release PR description and mark items when complete:

- [ ] Issue `#NNN` created with scope and timeline.
- [ ] Release branch `release/vX.Y.Z` created from `main`.
- [ ] Tests and linting pass (`npm test`, `npm run lint`).
- [ ] Documentation updated (`docs/index.md`, audience guides, this file).
- [ ] Version metadata updated (`template-version.json`, package manifests if applicable).
- [ ] Build artifacts generated (frontend static export, backend build, seed archive if required).
- [ ] GitHub Pages preview validated against sanitized demo data.
- [ ] Release notes drafted using `.github/release-template.md`.
- [ ] Tag `vX.Y.Z` pushed after merge.
- [ ] Release published with assets attached.

## Release Artifacts & Distribution

- **Source bundle**: automatically provided by GitHub (source ZIP/TAR). Label clearly in release notes.
- **Prebuilt frontend**: run `npm run -w frontend build` to produce the `.next` output and package it as `primer-frontend-vX.Y.Z.tar.gz` (or `.zip`).
- **Prebuilt backend**: run `npm run -w backend build:all` to compile plugins and Strapi, then package the project directory as `primer-backend-vX.Y.Z.tar.gz` (or `.zip`).
- **Seed data**: keep contributor seed data (`apps/backend/seed-data.tar.gz`) versioned in git for developer use; do not attach to release assets to avoid confusing non-developers.
- **Demo data for GitHub Pages**: use sanitized fixture data in the Pages branch/build so public demos do not expose contributor seed content.

## Automation

- Extend CI with a `release.yml` workflow triggered on `release` publication or manual dispatch:
  - Check out the tagged commit.
  - Install dependencies and run tests for verification.
  - Build frontend/backend bundles and upload them as release assets using `actions/upload-release-asset`.
  - Set `SKIP_BUILD_FETCH=true` for the frontend build to skip build-time API calls to Strapi.
  - Optionally publish built images/packages to GitHub Packages if future distribution requires it.
- Configure GitHub Pages to build from the `gh-pages` branch (or `/docs` folder) generated from the latest stable release. Automate this via workflow so each release updates the public demo with sanitized content.

## Release Notes Template

- Stored at `.github/release-template.md` and pre-populated when drafting a release.
- Sections: Summary, Added, Changed, Fixed, Upgrade Notes, Assets, Contributors, Acknowledgements.
- Include quick links to documentation and GitHub Pages demo for the release.

## Reverting a Release

- **Incorrect release notes or assets**: edit or delete the GitHub Release entry; re-upload assets and republish.
- **Wrong tag**: delete the tag both locally (`git tag -d vX.Y.Z`) and remotely (`git push origin :refs/tags/vX.Y.Z`), retag the correct commit, and push again.
- **Code regression**:
  - Revert the release merge commit via a new PR targeting `main`.
  - Mark the faulty release as “Deprecated” in GitHub by editing the release title/notes.
  - If hotfix needed, branch from the last good commit, apply fixes, and repeat the release process for a patched version (`v0.0.2`).

## Audience-specific Guidance

- **Contributor developers**: follow `docs/contributors.md` plus release notes for seed data updates and migration steps.
- **User developers**: download the tagged source archive; consult release notes for environment setup without seed data.
- **User non-developers**: grab prebuilt artifacts from the release assets; follow deployment instructions packaged inside the archives.

## Maintenance

- Review and update this document at every release to reflect tooling or process changes.
- Keep `.github/release-template.md` synchronized with the checklist and documentation expectations.
- Conduct a post-release retrospective when significant issues occur and record follow-up tasks in the relevant release issue.
